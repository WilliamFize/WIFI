#include "types.h"

#define OLED_SPI_RAM_SIZE	1024
#define OLED_SPI_DMA_CH		0

/*
  (0) !(1) "(2) #(3) $(4) %(5) &(6) '(7)
 ((8) )(9) *(10) +(11) ,(12) -(13) .(14) /(15)
 0(16) 1(17) 2(18) 3(19) 4(20) 5(21) 6(22) 7(23)
 8(24) 9(25) :(26) ;(27) <(28) =(29) >(30) ?(31)
 @(32) A(33) B(34) C(35) D(36) E(37) F(38) G(39)
 H(40) I(41) J(42) K(43) L(44) M(45) N(46) O(47)
 P(48) Q(49) R(50) S(51) T(52) U(53) V(54) W(55)
 X(56) Y(57) Z(58) [(59) \(60) ](61) ^(62) _(63)
 `(64) a(65) b(66) c(67) d(68) e(69) f(70) g(71)
 h(72) i(73) j(74) k(75) l(76) m(77) n(78) o(79)
 p(80) q(81) r(82) s(83) t(84) u(85) v(86) w(87)
 x(88) y(89) z(90) {(91) |(92) }(93) ~(94)
 */

static uc8 OLED_Ascii_8_16[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",0*/
	0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00,/*"!",1*/
	0x00,0x10,0x0C,0x06,0x10,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*""",2*/
	0x40,0xC0,0x78,0x40,0xC0,0x78,0x40,0x00,0x04,0x3F,0x04,0x04,0x3F,0x04,0x04,0x00,/*"#",3*/
	0x00,0x70,0x88,0xFC,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xFF,0x21,0x1E,0x00,0x00,/*"$",4*/
	0xF0,0x08,0xF0,0x00,0xE0,0x18,0x00,0x00,0x00,0x21,0x1C,0x03,0x1E,0x21,0x1E,0x00,/*"%",5*/
	0x00,0xF0,0x08,0x88,0x70,0x00,0x00,0x00,0x1E,0x21,0x23,0x24,0x19,0x27,0x21,0x10,/*"&",6*/
	0x10,0x16,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"'",7*/
	0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,/*"(",8*/
	0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00,/*")",9*/
	0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00,/*"*",10*/
	0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1F,0x01,0x01,0x01,0x00,/*"+",11*/
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xB0,0x70,0x00,0x00,0x00,0x00,0x00,/*",",12*/
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,/*"-",13*/
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00,/*".",14*/
	0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00,/*"/",15*/
	0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,/*"0",16*/
	0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,/*"1",17*/
	0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,/*"2",18*/
	0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,/*"3",19*/
	0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,/*"4",20*/
	0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,/*"5",21*/
	0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,/*"6",22*/
	0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,/*"7",23*/
	0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,/*"8",24*/
	0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,/*"9",25*/
	0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,/*":",26*/
	0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00,/*";",27*/
	0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00,/*"<",28*/
	0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,/*"=",29*/
	0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00,/*">",30*/
	0x00,0x70,0x48,0x08,0x08,0x08,0xF0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00,/*"?",31*/
	0xC0,0x30,0xC8,0x28,0xE8,0x10,0xE0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0B,0x00,/*"@",32*/
	0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,/*"A",33*/
	0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,/*"B",34*/
	0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,/*"C",35*/
	0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,/*"D",36*/
	0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,/*"E",37*/
	0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,/*"F",38*/
	0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,/*"G",39*/
	0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,/*"H",40*/
	0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,/*"I",41*/
	0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,/*"J",42*/
	0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,/*"K",43*/
	0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,/*"L",44*/
	0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,/*"M",45*/
	0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,/*"N",46*/
	0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,/*"O",47*/
	0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,/*"P",48*/
	0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,/*"Q",49*/
	0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,/*"R",50*/
	0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,/*"S",51*/
	0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,/*"T",52*/
	0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,/*"U",53*/
	0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,/*"V",54*/
	0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,/*"W",55*/
	0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,/*"X",56*/
	0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,/*"Y",57*/
	0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,/*"Z",58*/
	0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,/*"[",59*/
	0x00,0x0C,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xC0,0x00,/*"\",60*/
	0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,/*"]",61*/
	0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"^",62*/
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,/*"_",63*/
	0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"`",64*/
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x19,0x24,0x22,0x22,0x22,0x3F,0x20,/*"a",65*/
	0x08,0xF8,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x3F,0x11,0x20,0x20,0x11,0x0E,0x00,/*"b",66*/
	0x00,0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x0E,0x11,0x20,0x20,0x20,0x11,0x00,/*"c",67*/
	0x00,0x00,0x00,0x80,0x80,0x88,0xF8,0x00,0x00,0x0E,0x11,0x20,0x20,0x10,0x3F,0x20,/*"d",68*/
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x22,0x13,0x00,/*"e",69*/
	0x00,0x80,0x80,0xF0,0x88,0x88,0x88,0x18,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,/*"f",70*/
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x6B,0x94,0x94,0x94,0x93,0x60,0x00,/*"g",71*/
	0x08,0xF8,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,/*"h",72*/
	0x00,0x80,0x98,0x98,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,/*"i",73*/
	0x00,0x00,0x00,0x80,0x98,0x98,0x00,0x00,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,/*"j",74*/
	0x08,0xF8,0x00,0x00,0x80,0x80,0x80,0x00,0x20,0x3F,0x24,0x02,0x2D,0x30,0x20,0x00,/*"k",75*/
	0x00,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,/*"l",76*/
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x20,0x3F,0x20,0x00,0x3F,0x20,0x00,0x3F,/*"m",77*/
	0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x3F,0x21,0x00,0x00,0x20,0x3F,0x20,/*"n",78*/
	0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,/*"o",79*/
	0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x80,0xFF,0xA1,0x20,0x20,0x11,0x0E,0x00,/*"p",80*/
	0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x00,0x00,0x0E,0x11,0x20,0x20,0xA0,0xFF,0x80,/*"q",81*/
	0x80,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x20,0x20,0x3F,0x21,0x20,0x00,0x01,0x00,/*"r",82*/
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x33,0x24,0x24,0x24,0x24,0x19,0x00,/*"s",83*/
	0x00,0x80,0x80,0xE0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x20,0x00,0x00,/*"t",84*/
	0x80,0x80,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x1F,0x20,0x20,0x20,0x10,0x3F,0x20,/*"u",85*/
	0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x00,0x01,0x0E,0x30,0x08,0x06,0x01,0x00,/*"v",86*/
	0x80,0x80,0x00,0x80,0x00,0x80,0x80,0x80,0x0F,0x30,0x0C,0x03,0x0C,0x30,0x0F,0x00,/*"w",87*/
	0x00,0x80,0x80,0x00,0x80,0x80,0x80,0x00,0x00,0x20,0x31,0x2E,0x0E,0x31,0x20,0x00,/*"x",88*/
	0x80,0x80,0x80,0x00,0x00,0x80,0x80,0x80,0x80,0x81,0x8E,0x70,0x18,0x06,0x01,0x00,/*"y",89*/
	0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x21,0x30,0x2C,0x22,0x21,0x30,0x00,/*"z",90*/
	0x00,0x00,0x00,0x00,0x80,0x7C,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3F,0x40,0x40,/*"{",91*/
	0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,/*"|",92*/
	0x00,0x02,0x02,0x7C,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3F,0x00,0x00,0x00,0x00,/*"}",93*/
	0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"~",94*/
};


/*********************************************************************************
*OLED NO USE DMA SEND DEFINE
*********************************************************************************/
static void OLEDCPUSendCmd(u8 cmd)
{
	while(PDMA_IS_CH_BUSY(OLED_SPI_DMA_CH));
	GPIO_OLED_DC_PO(0);
	SPI_WRITE_TX0(SPI1, cmd);
	SPI_TRIGGER(SPI1);
	while(SPI_IS_BUSY(SPI1));
}

static void OLEDCPUSendDat(u8 dat)
{
	while(PDMA_IS_CH_BUSY(OLED_SPI_DMA_CH));
	GPIO_OLED_DC_PO(1);
    SPI_WRITE_TX0(SPI1, dat);
	SPI_TRIGGER(SPI1);
	while(SPI_IS_BUSY(SPI1));
}

static void OLEDCPUSetCol(u8 start, u8 end)
{
	OLEDCPUSendCmd(0x21);
	OLEDCPUSendCmd(start);
	OLEDCPUSendCmd(end);
}

static void OLEDCPUSetPage(u8 start, u8 end)
{
	OLEDCPUSendCmd(0x22);
	OLEDCPUSendCmd(start);
	OLEDCPUSendCmd(end);
}

static void OLEDCPUClear(void)
{
	u16 i;
	
	OLEDCPUSetCol(0, 127);
	OLEDCPUSetPage(0, 7);
	
	for(i = 0; i < OLED_SPI_RAM_SIZE; i++)
		OLEDCPUSendDat(0x00);
}

static void OLEDRegInit(void)
{
	OLEDCPUSendCmd(0xAE); //display off	

	OLEDCPUSendCmd(0x20);//set horizontal addressing mode
	
	OLEDCPUSendCmd(0x40); //set display start line
		
	OLEDCPUSendCmd(0x81); //contract control
	OLEDCPUSendCmd(0xB0); //128
	
	OLEDCPUSendCmd(0xA1); //set segment remap
	OLEDCPUSendCmd(0xA4); //output follows ram content
	OLEDCPUSendCmd(0xA6); //0->0ff display, 1->on display
	
	OLEDCPUSendCmd(0xA8); //multiplex ratio
	OLEDCPUSendCmd(0x3F); //duty = 1/64
	
	OLEDCPUSendCmd(0xC8); //Com scan direction
	
	OLEDCPUSendCmd(0xD3); //set display offset
	OLEDCPUSendCmd(0x00);
	
	OLEDCPUSendCmd(0xD5); //set osc division
	OLEDCPUSendCmd(0x90);
	
	OLEDCPUSendCmd(0xD9); //set pre-charge period
	OLEDCPUSendCmd(0x22);
	
	OLEDCPUSendCmd(0xDA); //set COM pins
	OLEDCPUSendCmd(0x12);
	
	OLEDCPUSendCmd(0xdb); //set vcomh
	OLEDCPUSendCmd(0x30);
	
	OLEDCPUSendCmd(0x8d); //set charge pump enable
	//OLEDCPUSendCmd(0x10);
	OLEDCPUSendCmd(0x95);

	OLEDCPUClear();
	
	OLEDCPUSendCmd(0xAF); //display ON
}

void OLEDCPUSendOff(void)
{
	OLEDCPUSendCmd(0xAE);
}

void OLEDCPUSendOn(void)
{
	OLEDCPUSendCmd(0xAF);
}
/*********************************************************************************
*OLED NO USE DMA SEND END
*********************************************************************************/


/*********************************************************************************
*OLED USE DMA SEND DEFINE
*********************************************************************************/
struct 
{
	u8	update;
	u32 align;
	u8	ram[OLED_SPI_RAM_SIZE];
	u8 	negation;
}oled;

void PDMA_IRQHandler(void)
{
	PDMA_CLR_CH_INT_FLAG(OLED_SPI_DMA_CH, PDMA_ISR_BLKD_IF_Msk);
}

void OLEDDMAPolling(void)
{
	if(oled.update)
	{
		if(PDMA_IS_CH_BUSY(OLED_SPI_DMA_CH) == 0)
		{
			GPIO_OLED_DC_PO(1);
			PDMA_SET_SRC_ADDR(OLED_SPI_DMA_CH, (u32)oled.ram);
			PDMA_Trigger(OLED_SPI_DMA_CH);
			SPI_TRIGGER_TX_PDMA(SPI1);
			oled.update   = FALSE;
		}
	}
}

void OLEDDMAUpdateImmediately(void)
{
	while(PDMA_IS_CH_BUSY(OLED_SPI_DMA_CH));
	GPIO_OLED_DC_PO(1);
	PDMA_SET_SRC_ADDR(OLED_SPI_DMA_CH, (u32)oled.ram);
	PDMA_Trigger(OLED_SPI_DMA_CH);
	SPI_TRIGGER_TX_PDMA(SPI1);
	oled.update   = FALSE;
}

void OLEDDMAUpdate(void)
{
	oled.update	= TRUE;
	timer0_1s_flag=0;
	if(oled.negation)
	{
		timer0_1s_flag=4;
		OLEDNegation();
	}
}

void OLEDDMAClearPic(void)
{
	if(!oled.negation)
		memset(oled.ram, 0x00, OLED_SPI_RAM_SIZE);
	else
		memset(oled.ram, 0xFF, OLED_SPI_RAM_SIZE);
	OLEDDMAUpdate();
}

void OLEDDMASetAllWhite(void)
{
	if(!oled.negation)
		memset(oled.ram, 0xFF, OLED_SPI_RAM_SIZE);
	else
		memset(oled.ram, 0x00, OLED_SPI_RAM_SIZE);
	OLEDDMAUpdate();
}

/*
*OLEDDMAShowPic(uc8 *pic, u8 w, u8 h, u8 col, u8 page)
*pic:picture data
*w:weigh
*h:h % 8 == 0
*col:0~127 
*page:0~7
*/
void OLEDDMAFill(u8 w, u8 h, u8 col, u8 page)
{
	u16 rom_p, ram_p;
	u16 i, j;
	
	rom_p = 0;
	h = h >> 3;//h = h / 8
	
	for(i = 0; i < h; i++)
	{
		ram_p = (page << 7) + col;//ram_p = page * 128 + col
		for(j = 0; j < w; j++)
		{
			if(!oled.negation)
				oled.ram[ram_p++] = 0x00;
			else
				oled.ram[ram_p++] = 0xff;
		}
			
		page++;
	}
	OLEDDMAUpdate();
}

/*
*OLEDDMAShowPic(uc8 *pic, u8 w, u8 h, u8 col, u8 page)
*pic:picture data
*w:weigh
*h:h % 8 == 0
*col:0~127 
*page:0~7
*/
void OLEDDMAShowPic(uc8 *pic, u8 w, u8 h, u8 col, u8 page)
{
	u16 rom_p, ram_p;
	u16 i, j;

	rom_p = 0;
	h = h >> 3;//h = h / 8
	
	for(i = 0; i < h; i++)
	{
		ram_p = (page << 7) + col;//ram_p = page * 128 + col
		for(j = 0; j < w; j++)
		{
			if(!oled.negation)
				oled.ram[ram_p++] = pic[rom_p++];
			else
				oled.ram[ram_p++] = ~pic[rom_p++];
		}
			
		page++;
	}
	OLEDDMAUpdate();
}

/*
*OLEDDMAShowChar(u8 ch, u8 col, u8 page)
*size: 8*16
*col:0~127 
*page:0~7
*/
void OLEDDMAShowChar(u8 ch, u8 col, u8 page)
{
	u16 rom_p, ram_p;
	u16 i, j;
	
	rom_p = (ch - 32) << 4;//(ch - 32)*16
	
	for(i = 0; i < 2; i++)
	{
		ram_p = (page << 7) + col;//page * 128 + col
		for(j = 0; j < 8; j++)
		{
			if(!oled.negation)
				oled.ram[ram_p++] = OLED_Ascii_8_16[rom_p++];
			else
				oled.ram[ram_p++] = ~OLED_Ascii_8_16[rom_p++];
		}
			
		page++;
	}
	OLEDDMAUpdate();
}

/*
*OLEDDMAShowStr(uc8 *str, u8 col, u8 page)
*size: 8*16
*col:0~127 
*page:0~7
*/
void OLEDDMAShowStr(uc8 *str, u8 col, u8 page)
{
	u8 char_i = 0;
  
	while(str[char_i] != '\0')
  	{
  		OLEDDMAShowChar(str[char_i++], col, page);
		col += 8;
		if(col > 127)
		{
			col = 0;page += 2;
			if(page > 7) break;
		}
	}
}

/*
*OLEDDMAShowNum(u32 num, u8 col, u8 page)
*size: 8*16
*num:0~4294967295
*col:0~127 
*page:0~7
*/
void OLEDDMAShowNum(u32 num, u8 col, u8 page)
{
	u8 temp[10] = {0};
	sprintf(temp, "%d", num);
	OLEDDMAShowStr((uc8 *)temp, col, page);
}

/*
*OLEDDMAShowNumFill(u32 num, u8 col, u8 page)
*size: 8*16
*len:n num
*num:0~4294967295
*col:0~127 
*page:0~7
*/
void OLEDDMAShowNumFill(u32 num, u8 len, u8 col, u8 page)
{
	u8 t, temp;
	u8 enshow = 0;	
	
	for(t = 0; t < len; t++)
	{
		temp = (num / M_Pow_N(10, len - t - 1)) % 10;
		if(enshow == 0 && t < (len - 1))
		{
			if(temp == 0)
			{
				OLEDDMAShowChar('0', col, page);
				col += 8;
				continue;
			}
			else 
				enshow=1; 
		 	 
		}
		OLEDDMAShowChar(temp+'0', col, page);
		col += 8;
	}
}
/*********************************************************************************
*OLED USE DMA SEND END
*********************************************************************************/

void OLEDSpiInit(void)
{
	SYS_UnlockReg();
	CLK_SetModuleClock(SPI1_MODULE, CLK_CLKSEL1_SPI1_S_HCLK, MODULE_NoMsk);
	CLK_EnableModuleClock(SPI1_MODULE);
	SYS->GPC_MFP  &= ~(SYS_GPC_MFP_PC8_Msk | SYS_GPC_MFP_PC9_Msk | SYS_GPC_MFP_PC11_Msk);
    SYS->GPC_MFP  |= (SYS_GPC_MFP_PC8_SPI1_SS0 | SYS_GPC_MFP_PC9_SPI1_CLK | SYS_GPC_MFP_PC11_SPI1_MOSI0);
	SYS->ALT_MFP1 &= ~(SYS_ALT_MFP1_PC8_Msk);
    SYS->ALT_MFP1 |= SYS_ALT_MFP1_PC8_SPI1_SS0;
	SYS_ResetModule(SPI1_RST);
	SPI_Open(SPI1, SPI_MASTER, SPI_MODE_3, 8, 10000000);
    SPI_EnableAutoSS(SPI1, SPI_SS0, SPI_SS_ACTIVE_LOW);
	SYS_LockReg();

	GPIO_OLED_VBAT_PO(1);
	GPIO_OLED_RST_PO(0);
	delay_ms(100);
	GPIO_OLED_RST_PO(1);
	delay_ms(100);

	OLEDRegInit();

	CLK_EnableModuleClock(PDMA_MODULE);
	SYS_ResetModule(PDMA_RST);
	PDMA_Open(1 << OLED_SPI_DMA_CH);
    PDMA_SetTransferCnt(OLED_SPI_DMA_CH, PDMA_WIDTH_8, OLED_SPI_RAM_SIZE);
    PDMA_SetTransferAddr(OLED_SPI_DMA_CH, (u32)oled.ram, PDMA_SAR_INC, (u32)&SPI1->TX[0], PDMA_DAR_FIX);
	PDMA_SetTransferMode(OLED_SPI_DMA_CH, PDMA_SPI1_TX, NULL, NULL);
    PDMA_EnableInt(OLED_SPI_DMA_CH, PDMA_IER_BLKD_IE_Msk);
    NVIC_EnableIRQ(PDMA_IRQn);
	oled.negation=0;
}

void OLEDNegation(void)
{
	u16 i=0;
	if(timer0_1s_flag<4)//60秒。没有按键操作。则屏幕反显
	{
		timer0_1s_flag++;
	}
	else
	{
		timer0_1s_flag=0;
		for(i=0;i<OLED_SPI_RAM_SIZE;i++)
		{
			oled.ram[i]=~oled.ram[i];
		}
		oled.negation=!oled.negation;
		oled.update	= TRUE;
	}
	
}
